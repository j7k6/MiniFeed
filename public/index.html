<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MiniFeed</title>
  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
    }

    body {
      font-family: sans-serif;
      line-height: 1.6;
      background: #f4f4f4;
      color: #444;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    } 

    .items {
      width: calc(100vw - 4rem);
      margin: 2rem auto;
    }

    .items article {
      margin: 2rem auto;
      background: #fff;
      padding: 1rem;
    }

    .items article.new {
      animation: fadein 2s;
    }

    @keyframes fadein {
        from { opacity: 0; }
        to   { opacity: 1; }
    }

    .items article > * {
      margin: .25rem;
    }

    .items article p {
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .items article h6 {
      font-weight: normal;
      color: #aaa;
    }

    .items article h5 {
      background-repeat: no-repeat;
      background-position: center left;
      padding-left: 20px;
      white-space: nowrap;
      overflow: hidden;
    }
  </style>
  <script>
    var lastTimestamp;
    var feeds;

    function getItems(since) {
      var items_html =  document.querySelector('.items');

      Array.from(document.querySelectorAll('article')).forEach((el) => el.classList.remove('new'));

      fetch('/api/getItems?since='+since).then(function(res) {
        return res.json();
      }).then(function(data) {
        if (data.length > 0) {
          console.log(data.length);
          lastTimestamp = data[0].added;

          if (Array.from(document.querySelectorAll('article')).length > 0) {
            data.sort((a, b) => (a.published > b.published) ? 1 : -1)
          }

          data.forEach(function(item) {
            var feed = feeds.find(f => f.id === item.feed)

            var published = new Intl.DateTimeFormat('en-US', {
              year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: false,
              timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }).format(new Date(item.published*1000));

            var item_html = '\
                  <article class="new">\
                    <h5 class="feed_'+feed.id+'">\
                      <span>'+feed.title+':</span>\
                    </h5>\
                    <h4><a href="'+item.link+'" target="_blank">'+item.title+'</a></h4>\
                    <h6>'+published+'</h6>\
                    <p>'+item.description+'</p>\
                  </article>';

            items_html.innerHTML = item_html + items_html.innerHTML;
          });
        }
      }).catch(function(err) {
        console.log(err)
      });
    }

    fetch('/api/getFeeds').then(function(res) {
      return res.json();
    }).then(function(data) {
      feeds = data;

      var style = document.createElement('style');
      style.type = 'text/css';

      feeds.forEach(function(feed) {
        if (feed.favicon === '') {
          style.innerHTML = style.innerHTML + '.feed_'+feed.id+' { padding-left: 0 !important; }';
        } else {
          style.innerHTML = style.innerHTML + '.feed_'+feed.id+' { background-image: url(\'data:image/png;base64, '+feed.favicon+'\'); }';
        }
      });

      document.getElementsByTagName('head')[0].appendChild(style);

      getItems(0);
    }).catch(function(err) {
      console.log(err)
    });

    setInterval(function() { 
      getItems(lastTimestamp); 
    }, 10000);
  </script>
</head>

<body>
  <div class="items">

  </div>
</body>
</html>
